<!DOCTYPE html>
<html>

<head>
    <title>Manage JSON Data</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!-- Include Flatpickr CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        .input-section {
            margin: 20px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 120mm;
            box-sizing: border-box;
        }

        .input-section label {
            display: block;
            margin: 10px 0 5px;
        }

        .input-section input {
            width: 100%;
            padding: 5px;
            font-size: 10pt;
        }

        .input-section button {
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 10pt;
            cursor: pointer;
        }
    </style>
</head>

<body class="p-4">
    <div class="container my-4">
        <h2 class="mb-4 text-center">ðŸ“‹ JSON Data Table</h2>

        <div class="table-responsive">
            <table id="jsonTable" class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Bill No.</th>
                        <th>Bill Date</th>
                        <th>Transporter</th>
                        <th>Mode</th>
                        <th>Vehicle No.</th>
                        <th>Ticket No.</th>
                        <th>E-Way Bill</th>
                        <th>Supply Date</th>
                        <th>Net Qty (MT)</th>
                        <th>Total (â‚¹)</th>
                        <th>Rounded Total</th>
                        <th>Amount in Words</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h4 class="mt-5">âž• Add New Invoice</h4>
        <form id="addForm" class="row g-3">
            <div class="col-md-6 col-lg-4">
                <label>Bill No.</label>
                <input type="text" id="billNo" class="form-control" placeholder="WGL/SGSL/A-0338" required>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Bill Date</label>
                <input type="text" id="billDate" class="form-control flatpickr" placeholder="DD/MM/YYYY" required>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Transporter Name</label>
                <input list="transporterOptions" id="transporterName" class="form-control" placeholder="Ravinder"
                    required>
                <datalist id="transporterOptions">
                    <option value="Ravinder">
                    <option value="Kasi">
                    <option value="Mani">
                </datalist>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Mode of Transport</label>
                <input list="transportOptions" id="modeOfTransport" class="form-control" placeholder="TRUCK (TIPPER)"
                    required>
                <datalist id="transportOptions">
                    <option value="TRUCK (TIPPER)">
                    <option value="TRACTOR & TROLLEY">
                </datalist>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Vehicle No.</label>
                <input list="vehicleOptions" id="vehicleNo" class="form-control" placeholder="TS 19 T 5677" required>
                <datalist id="vehicleOptions">
                    <option value="TN 18 AB 1350">
                    <option value="TS 19 T 5677">
                    <option value="TN 18 BL 7767">
                    <option value="TN 18 BK 8749">
                </datalist>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Ticket No.</label>
                <input type="text" id="ticketNo" class="form-control" placeholder="207" required>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>E-Way Bill No.</label>
                <input type="text" id="eWayBillNo" class="form-control" placeholder="0000 0000 0000 0000">
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Date of Supply</label>
                <input type="text" id="dateOfSupply" class="form-control flatpickr" placeholder="DD/MM/YYYY" required>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Net Qty (MT)</label>
                <input type="text" id="netQty" class="form-control" placeholder="23.04" required>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Total (â‚¹)</label>
                <input type="text" id="total" class="form-control" readonly>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Rounded Total</label>
                <input type="text" id="totalRounded" class="form-control" readonly>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Amount in Words</label>
                <input type="text" id="totalInWords" class="form-control" readonly>
            </div>
            <div class="col-md-6 col-lg-4">
                <label>Invoice Status</label>
                <input list="invoiceStatusOptions" id="invoiceStatus" class="form-control" placeholder="Not Submitted"
                    required>
                <datalist id="invoiceStatusOptions">
                    <option value="Not Submitted">
                    <option value="Submitted">
                </datalist>
            </div>
            <div class="col-12 text-end mt-3">
                <button type="button" class="btn btn-secondary me-2" onclick="multiplyNumbers()">Update Amount</button>
                <button type="submit" class="btn btn-primary">Add & Save</button>
            </div>
        </form>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
        let table;

        function loadData() {
            fetch('/data.json')
                .then(res => res.json())
                .then(data => {
                    table.clear();
                    data.forEach((row, index) => {
                        table.row.add([
                            `<span class="billNo">${row.billNo}</span>`,
                            `<span class="billDate">${row.billDate}</span>`,
                            `<span class="transporterName">${row.transporterName}</span>`,
                            `<span class="modeOfTransport">${row.modeOfTransport}</span>`,
                            `<span class="vehicleNo">${row.vehicleNo}</span>`,
                            `<span class="ticketNo">${row.ticketNo}</span>`,
                            `<span class="eWayBillNo">${row.eWayBillNo}</span>`,
                            `<span class="dateOfSupply">${row.dateOfSupply}</span>`,
                            `<span class="netQty">${row.netQty}</span>`,
                            `<span class="total">${row.total}</span>`,
                            `<span class="totalRounded">${row.totalRounded}</span>`,
                            `<span class="totalInWords">${row.totalInWords}</span>`,
                            `<span class="invoiceStatus">${row.invoiceStatus}</span>`,
                            `<button class="btn btn-warning btn-sm edit" data-index="${index}">ðŸ–‰ Edit</button>`
                        ]);

                    });
                    table.draw();
                });
        }

        $(document).ready(function () {
            table = $('#jsonTable').DataTable();

            loadData();

            $('#addForm').on('submit', function (e) {
                e.preventDefault();
                const billNo = this.billNo.value;
                const billDate = this.billDate.value;
                const transporterName = this.transporterName.value;
                const modeOfTransport = this.modeOfTransport.value;
                const vehicleNo = this.vehicleNo.value;
                const ticketNo = this.ticketNo.value;
                const eWayBillNo = this.eWayBillNo.value;
                const dateOfSupply = this.dateOfSupply.value;
                const netQty = this.netQty.value;
                const total = this.total.value;
                const totalRounded = this.totalRounded.value;
                const totalInWords = this.totalInWords.value;
                const invoiceStatus = this.invoiceStatus.value;

                fetch('/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        billNo, billDate, transporterName, modeOfTransport, vehicleNo,
                        ticketNo, eWayBillNo, dateOfSupply, netQty, total,
                        totalRounded, totalInWords, invoiceStatus
                    })
                }).then(() => {
                    this.reset();
                    loadData();
                });
            });

            $('#jsonTable tbody').on('click', '.save', function () {
                const index = this.dataset.index;
                const row = $(this).closest('tr');

                function getValue(className) {
                    const el = row.find(`.${className}`);
                    return el.is('input') ? el.val() : el.text();
                }

                const billNo = getValue('billNo');
                const billDate = getValue('billDate');
                const transporterName = getValue('transporterName');
                const modeOfTransport = getValue('modeOfTransport');
                const vehicleNo = getValue('vehicleNo');
                const ticketNo = getValue('ticketNo');
                const eWayBillNo = getValue('eWayBillNo');
                const dateOfSupply = getValue('dateOfSupply');
                const netQty = getValue('netQty');
                const total = getValue('total');
                const totalRounded = getValue('totalRounded');
                const totalInWords = getValue('totalInWords');
                const invoiceStatus = getValue('invoiceStatus');
                console.log('Saving row:', {
                    index, billNo, billDate, transporterName, modeOfTransport,
                    vehicleNo, ticketNo, eWayBillNo, dateOfSupply, netQty,
                    total, totalRounded, totalInWords, invoiceStatus
                });

                fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        index, billNo, billDate, transporterName, modeOfTransport,
                        vehicleNo, ticketNo, eWayBillNo, dateOfSupply, netQty,
                        total, totalRounded, totalInWords, invoiceStatus
                    })
                }).then(() => loadData());
            });

            $('#jsonTable tbody').on('click', '.delete', function () {
                const index = this.dataset.index;
                fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index })
                }).then(() => loadData());
            });
        });

        function multiplyNumbers() {
            const num1 = parseFloat(document.getElementById('netQty').value);
            const num2 = 2160;

            // Check if the inputs are valid numbers
            if (!isNaN(num1) && !isNaN(num2)) {
                const result = (num1 * num2).toFixed(2);
                const product = Math.trunc(num1 * num2) + ".00";

                document.getElementById('total').value = result;
                document.getElementById('totalRounded').value = product;
                // document.getElementById('totalBeforeTax').value = product;
                // document.getElementById('totalAfterTax').value = product;

                function convertToWords(num) {
                    const a = [
                        '', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE', 'TEN',
                        'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'
                    ];
                    const b = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];

                    function numToWords(n) {
                        if (n < 20) return a[n];
                        if (n < 100) return b[Math.floor(n / 10)] + (n % 10 ? '-' + a[n % 10] : '');
                        if (n < 1000) return a[Math.floor(n / 100)] + ' HUNDRED' + (n % 100 ? ' ' + numToWords(n % 100) : '');
                        if (n < 100000) return numToWords(Math.floor(n / 1000)) + ' THOUSAND' + (n % 1000 ? ' ' + numToWords(n % 1000) : '');
                        return '';
                    }

                    return numToWords(num) + ' RUPEES ONLY';
                }
                document.getElementById('totalInWords').value = convertToWords(Math.trunc(num1 * num2))
                console.log(convertToWords(Math.trunc(num1 * num2)));

                // ðŸš¨ Check for E-Way Bill requirement
                if (parseInt(product.replace(".00", "")) > 50000) {
                    // const eBillAlert = "Amount is above 50,000 Rupees. Create E-Way Bill and submit Invoice <br> https://ewaybillgst.gov.in/login.aspx";
                    // document.getElementById("eBillAlert").textContent = eBillAlert;
                    // document.getElementById("eBillSystem").textContent = "Click Here to Generate E-Way Bill";
                } else {
                    // document.getElementById("eBillAlert").textContent = "E-Way Bill NOT Required(Amount < Rs.50,000)";
                    // document.getElementById("eBillSystem").textContent = "";
                }
            } else {
                document.getElementById('total').value = "Invalid input";
            }
        }

        flatpickr("#billDate", {
            dateFormat: "d/m/Y", // dd/mm/yyyy format
            allowInput: true
        });

        flatpickr("#dateOfSupply", {
            dateFormat: "d/m/Y", // dd/mm/yyyy format
            allowInput: true
        });

        $('#jsonTable tbody').on('click', '.edit', function () {
            const index = this.dataset.index;
            const row = $(this).closest('tr');

            row.find('span').each(function () {
                const value = $(this).text();
                const className = $(this).attr('class');
                $(this).replaceWith(`<input type="text" class="form-control ${className}" value="${value}">`);
            });

            $(this).replaceWith(`
    <button class="btn btn-success btn-sm save" data-index="${index}">ðŸ’¾ Save</button>
    <button class="btn btn-secondary btn-sm cancel">âœ– Cancel</button>
  `);
        });

        $('#jsonTable tbody').on('click', '.cancel', function () {
            loadData(); // Reloads the original data from JSON
        });


    </script>
</body>

</html>